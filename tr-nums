#!/usr/bin/env python
import argparse
from fractions import Fraction
from itertools import islice

# from scipy.special import beta
from scipy.special import gamma

DEFAULT_MAX_NUMBERS = 10


def inv_tr_nums(d=Fraction(2), n=Fraction(1)):
    """
    Generate inverse triangular numbers.

    Parameters:
    d (Fraction): The dimension for the generalized triangular number.
    n (Fraction): The starting index for the triangular number sequence.

    Yields:
    Fraction: The next inverse triangular number.

    Examples:
    >>> gen = inv_tr_nums(Fraction(2), Fraction(1))
    >>> next(gen)
    Fraction(1, 1)
    >>> next(gen)
    Fraction(1, 3)
    """
    while True:
        # yield d * beta(n, n + d)
        yield 1 / Fraction((gamma(float(n + d)) / (gamma(float(n)) * gamma(
            float(d + 1)))))
        n += 1


def inv_gap_nums(d=Fraction(2), n=Fraction(1)):
    """
    Generate the preceding "gap" number inverse triangular numbers.

    Parameters:
    d (Fraction): The dimension for the generalized triangular number.
    n (Fraction): The starting index for the triangular number sequence.

    Yields:
    Fraction: The next preceding gap number.

    Examples:
    >>> gen = inv_gap_nums(Fraction(2), Fraction(1))
    >>> next(gen)
    Fraction(0, 1)
    >>> next(gen)
    Fraction(1, 3)
    """
    x = -1
    gen_inv_tr_nums = inv_tr_nums(d, n)
    # Skip ahead -- DOES NOT WORK for negative indices!
    for _ in range(int(n - 1)):
        x += next(gen_inv_tr_nums)
    while True:
        x += next(gen_inv_tr_nums)
        yield x


def main():
    dimension = args.dimension
    start = args.starting_index
    nums = args.max_numbers

    gen = inv_tr_nums(dimension, start)
    for num in islice(gen, nums):
        print(num)
    print('---')
    gen = inv_gap_nums(dimension, start)
    for num in islice(gen, nums + 1):
        print(num)


def parse_args():
    def parse_fraction(value):
        try:
            return Fraction(value)
        except ValueError:
            raise argparse.ArgumentTypeError(f"Invalid fraction value: {value}")

    parser = argparse.ArgumentParser(
        description='Print inverse triangular numbers and their gaps.'
    )
    parser.add_argument(
        '-d',
        '--dimension',
        type=parse_fraction,
        default=Fraction(2),
        metavar='DIM',
        help='generate triangular numbers of DIM dimension'
    )
    parser.add_argument(
        '-i',
        '--starting-index',
        type=parse_fraction,
        default=Fraction(1),
        metavar='INDEX',
        help='start at the INDEX-th triangular number'
    )
    parser.add_argument(
        '-n',
        '--max-numbers',
        type=int,
        default=DEFAULT_MAX_NUMBERS,
        metavar='MAX',
        help='generate only MAX triangular numbers'
    )
    parser.add_argument(
        '-T',
        '--unit-tests',
        action='store_true',
        help='run unit tests instead of printing'
    )
    return parser.parse_args()


def unit_tests():
    import doctest
    doctest.testmod()


if __name__ == '__main__':
    args = parse_args()

    if args.unit_tests:
        unit_tests()
    else:
        main()
